<!-- prettier-ignore-start -->
{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Artigos Cient√≠ficos - Innovator</title>
    <link rel="stylesheet" href="{% static 'styles/home.css' %}" />
  <link rel="stylesheet" href="{% static 'styles/artigos.css' %}" />
  <!-- Icon libraries for sidebar -->
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pZfgb5iQ2c3F1ozz0Ix4do05k7OC5nL3qE+R1Yv4CM4eW9MuRGBnW3n3rMWYpuV8k2fMiYjVZZ3+5Rexm3dbZg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    {% include 'components/topbar.html' %}

    <div class="container">
      {% include 'components/sidebar.html' %}

      <!-- MAIN CONTENT -->
      <div class="main-content">
        
        <div class="artigos-header">
          <form method="get" class="search-box search-form" style="flex: 1">
            <input
              type="text"
              id="search-input"
              name="q"
              placeholder="Pesquisar por pesquisador, t√≠tulo ou √°rea"
              value="{{ search_query|default:'' }}"
              style="width: 100%; border: 1px solid #ccc; border-radius: 20px; padding: 10px 16px; outline: none;"
            />
          </form>
          <button
            id="add-article-btn"
            class="plus-btn"
            title="Adicionar artigo"
          >
            <span>+</span>
          </button>
        </div>
        <div id="article-modal" class="modal" style="display: none">
          <div class="modal-content">
            <span class="close-modal" id="close-article-modal">&times;</span>
            <h3>Publicar Novo Artigo</h3>
            <form
              method="POST"
              enctype="multipart/form-data"
              id="article-upload-form"
            >
              {% csrf_token %} {% if form.non_field_errors %}
              <div class="form-errors">{{ form.non_field_errors }}</div>
              {% endif %}

              <div class="form-group">
                <label for="{{ form.pdf.id_for_label }}">Arquivo PDF:</label>
                {{ form.pdf }} {% if form.pdf.errors %}
                <div class="field-errors">{{ form.pdf.errors }}</div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.title.id_for_label }}"
                  >T√≠tulo do Artigo:</label
                >
                {{ form.title }} {% if form.title.errors %}
                <div class="field-errors">{{ form.title.errors }}</div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.research_area.id_for_label }}"
                  >√Årea de Pesquisa:</label
                >
                {{ form.research_area }} {% if form.research_area.errors %}
                <div class="field-errors">{{ form.research_area.errors }}</div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.qualis_capes.id_for_label }}"
                  >Qualis Capes:</label
                >
                {{ form.qualis_capes }} {% if form.qualis_capes.errors %}
                <div class="field-errors">{{ form.qualis_capes.errors }}</div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.description.id_for_label }}"
                  >Descri√ß√£o:</label
                >
                {{ form.description }} {% if form.description.errors %}
                <div class="field-errors">{{ form.description.errors }}</div>
                {% endif %}
              </div>



              <div class="form-actions">
                <button type="button" id="cancel-article" class="btn-cancel">
                  Cancelar
                </button>
                <button type="submit" class="btn-submit">
                  Publicar Artigo
                </button>
              </div>
            </form>
          </div>
        </div>
        <!-- Lista de artigos -->
        <div class="artigos-lista">
          {% for article in articles %}
            <!-- Post -->
            <div class="post-container">
              <div class="post-row">
                <div class="user-profile">
                  <img src="{{ article.user.get_profile_picture_url }}" alt="{{ article.user.fullname }}">
                  <div>
                    <p>{{ article.user.fullname }}</p>
                    {% if article.user.innovator_verification and article.user.innovator_verification.title %}
                      <small>{{ article.user.innovator_verification.title }}</small>
                    {% else %}
                      <small>{{ article.user.research_area|default:"Pesquisador" }}</small>
                    {% endif %}
                    <small style="color: #666;">{{ article.created_at|date:"d/m/Y H:i" }}</small>
                  </div>
                </div>
              </div>
              <p class="post-text">{{ article.title }}</p>
              {% if article.description %}
                <div class="post-description">
                  {% if article.description|length > 220 %}
                    <span class="desc-short">{{ article.description|slice:":220" }}...</span>
                    <span class="desc-full" style="display: none;">{{ article.description }}</span>
                    <button class="desc-toggle" onclick="toggleDesc(this); return false;" style="background: none; border: none; color: #28a745; cursor: pointer; padding: 0; margin-left: 4px;">mais</button>
                  {% else %}
                    <p>{{ article.description }}</p>
                  {% endif %}
                </div>
              {% endif %}
              
              <small style="color: #666; display: block; margin: 10px 0;">
                üìö {{ article.get_research_area_display }} ‚Ä¢ Qualis: {{ article.qualis_capes }}
              </small>
              
              <div class="post-activity">
                <a href="{{ article.pdf.url }}" target="_blank" class="activity-link" style="display: inline-block; padding: 8px 16px; background-color: #256d4a; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
                  üìÑ Ver PDF
                </a>
              </div>
            </div>
          {% empty %}
            <div class="post-container">
              <p style="text-align: center; color: #666; padding: 40px;">
                Nenhum artigo publicado ainda.
              </p>
            </div>
          {% endfor %}
        </div>
        
        <script>
          function toggleDesc(btn) {
            var container = btn.closest(".post-description");
            var shortDesc = container.querySelector(".desc-short");
            var fullDesc = container.querySelector(".desc-full");
            if (shortDesc.style.display !== "none") {
              shortDesc.style.display = "none";
              fullDesc.style.display = "inline";
              btn.textContent = "menos";
              btn.style.color = "#28a745";
            } else {
              shortDesc.style.display = "inline";
              fullDesc.style.display = "none";
              btn.textContent = "mais";
              btn.style.color = "#28a745";
            }
          }
        </script>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="right-sidebar">
        <div class="sidebar-title">
          <h4>Conversas</h4>
        </div>
        {% if top_message_users %}
          {% for user in top_message_users|slice:":5" %}
            <div class="online-list">
              <div class="online">
                <img src="{{ user.get_profile_picture_url }}" alt="{{ user.fullname }}">
              </div>
              <a href="{% url 'feed:mensagens' %}?user={{ user.id }}" style="color: inherit; text-decoration: none;">
                <p style="margin: 0; cursor: pointer;">{{ user.fullname }}</p>
              </a>
            </div>
          {% empty %}
            <p style="color: #888; margin: 12px 0 0 12px;">Nenhuma conversa recente.</p>
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <div class="footer"><p>Innovator 2025</p></div>
    <script src="{% static 'js/artigos.js' %}"></script>
    <script src="{% static 'js/search.js' %}"></script>
    <script src="{% static 'js/home.js' %}"></script>
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          var bell = document.getElementById('notification-bell');
          var dropdown = document.getElementById('notification-dropdown');
          if (bell && dropdown) {
            bell.addEventListener('click', function(e) {
              e.stopPropagation();
              dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('mousedown', function(e) {
              if (dropdown.style.display === 'block' && !dropdown.contains(e.target) && e.target !== bell) {
                dropdown.style.display = 'none';
              }
            });
          }
        });
      </script>
    <style>
      #notification-dropdown {
        z-index: 2147483647 !important;
        box-shadow: 0 4px 24px rgba(0,0,0,0.18) !important;
        border-radius: 10px !important;
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        var bell = document.getElementById('notification-bell');
        var dropdown = document.getElementById('notification-dropdown');
        if (bell && dropdown) {
          bell.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
          });
          document.addEventListener('mousedown', function(e) {
            if (dropdown.style.display === 'block' && !dropdown.contains(e.target) && e.target !== bell) {
              dropdown.style.display = 'none';
            }
          });
        }
      });
    </script>

    <!-- Payment Modal -->
    <div id="pay-modal" class="modal" style="display: none">
      <div class="modal-content" style="min-width: 320px">
        <span class="close-modal" id="close-pay-modal">&times;</span>
        <h3>Pagamento Necess√°rio</h3>
        <p>Para acessar este artigo, realize o pagamento via Pix:</p>
        <div
          style="
            background: #f8f8f8;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
          "
        >
          <input
            type="text"
            id="pix-key"
            value="chave-pix-exemplo@pagamento.com"
            readonly
            style="
              width: 100%;
              border: none;
              background: transparent;
              font-size: 1.1em;
            "
          />
          <button onclick="copyPixKey()" style="margin-top: 4px">
            Copiar chave Pix
          </button>
        </div>
        <p>
          Ap√≥s o pagamento, clique em pedir acesso para conseguir acessar o
          artigo.
        </p>
      </div>
    </div>
    <script>
      function showPayModal(title, price) {
        document.getElementById("pay-modal").style.display = "flex";
      }
      document.getElementById("close-pay-modal").onclick = function () {
        document.getElementById("pay-modal").style.display = "none";
      };
      function copyPixKey() {
        var pixInput = document.getElementById("pix-key");
        pixInput.select();
        pixInput.setSelectionRange(0, 99999);
        document.execCommand("copy");
        alert("Chave Pix copiada!");
      }
    </script>

    <!-- Access Request Modal -->
    <div id="access-modal" class="modal" style="display: none">
      <div class="modal-content" style="min-width: 320px">
        <span class="close-modal" id="close-access-modal">&times;</span>
        <h3>Pedir acesso ao artigo</h3>
        <form
          method="post"
          enctype="multipart/form-data"
          id="access-request-form"
        >
          {% csrf_token %}
          <input type="hidden" name="article_id" id="access-article-id" />
          <label for="slip-upload"
            >Envie o comprovante de pagamento (PDF ou imagem):</label
          >
          <input
            type="file"
            id="slip-upload"
            name="slip"
            accept="application/pdf,image/*"
            required
          />
          <div
            id="access-error-message"
            style="color: red; margin: 8px 0; display: none"
          ></div>
          <button type="submit">Enviar pedido</button>
        </form>
      </div>
    </div>
    <script>
      function showAccessModal(articleId) {
        document.getElementById("access-modal").style.display = "flex";
        document.getElementById("access-article-id").value = articleId;
        document.getElementById("access-error-message").style.display = "none";
      }
      document.getElementById("close-access-modal").onclick = function () {
        document.getElementById("access-modal").style.display = "none";
      };

      // Client-side error handling for access request form
      document
        .getElementById("access-request-form")
        .addEventListener("submit", function (e) {
          var slip = document.getElementById("slip-upload").files[0];
          var errorDiv = document.getElementById("access-error-message");
          errorDiv.style.display = "none";
          errorDiv.textContent = "";
          if (!slip) {
            e.preventDefault();
            errorDiv.textContent =
              "Por favor, envie o comprovante de pagamento.";
            errorDiv.style.display = "block";
            return false;
          }
          // Optionally, check file type/size here
        });

      // Handle cancel button for article form
      document.addEventListener("DOMContentLoaded", function () {
        const cancelBtn = document.getElementById("cancel-article");
        const modal = document.getElementById("article-modal");

        if (cancelBtn && modal) {
          cancelBtn.addEventListener("click", function () {
            modal.style.display = "none";
          });
        }
      });
    </script>
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          var bell = document.getElementById('notification-bell');
          var dropdown = document.getElementById('notification-dropdown');
          if (bell && dropdown) {
            bell.addEventListener('click', function(e) {
              e.stopPropagation();
              dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('mousedown', function(e) {
              if (dropdown.style.display === 'block' && !dropdown.contains(e.target) && e.target !== bell) {
                dropdown.style.display = 'none';
              }
            });
          }
        });
      </script>
  </body>
</html>
