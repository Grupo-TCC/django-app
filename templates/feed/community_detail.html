{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
	<!-- Toastr CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Detalhes da Comunidade</title>
	<link rel="stylesheet" href="{% static 'styles/home.css' %}">
	<!-- Removido script do head para garantir que o DOM esteja pronto -->
</head>
<body>
	<!-- Toastr JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
	<!-- Navbar -->
	<nav>
		<div class="nav-left">
			<a href="{% url 'feed:artigos' %}"><img src="{% static 'assets/img/logo.png' %}" class="logo"></a>
			<ul>


				<li><a href="{% url 'feed:mensagens' %}"><img src="{% static 'assets/img/inbox.png' %}" alt="Mensagens" style="cursor:pointer;"></a></li>
			</ul>
		</div>
		<div class="nav-right">
			<form class="search-box" method="get" action="">
				<img src="{% static 'assets/img/search.png' %}">
				<input type="text" name="q" placeholder="Pesquisar artigos, pesquisadores ou áreas" value="">
			</form>
			<div class="nav-user-icon online" onclick="settingsMenuToggle()">
				<img src="{{ profile_user.get_profile_picture_url }}">
			</div>
			<div class="settings-menu">
				<div id="dark-btn"><span></span></div>
				<div class="settings-menu-inner">
					<div class="user-profile">
						<img src="{{ profile_user.get_profile_picture_url }}">
						<div>
							<p>{{ profile_user.fullname }}</p>
							<a href="{% url 'feed:perfil' %}">Ver Perfil</a>
						</div>
					</div>
					<hr>
					<div class="user-profile">
						<img src="{% static 'assets/img/feedback.png' %}">
						<div>
							<p>Nos dê seu feedback</p>
							<a href="#">Ajude a melhorar nosso site</a>
						</div>
					</div>
					<hr>
					<div class="settings-links">
						<img src="{% static 'assets/img/setting.png' %}" class="settings-icon">
						<a href="{% url 'feed:settings' %}">Configuração & Privacidade <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
					</div>
					<div class="settings-links">
						<img src="{% static 'assets/img/help.png' %}" class="settings-icon">
						<a href="#">Ajuda <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
					</div>
					<div class="settings-links">
						<img src="{% static 'assets/img/logout.png' %}" class="settings-icon">
						<a href="{% url 'logout' %}">Sair <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
					</div>
				</div>
			</div>
		</div>
	</nav>
	<!-- Conteúdo da página community_detail -->
			<script src="{% static 'js/home.js' %}"></script>

		<script>
			// Abas de mensagens e arquivos
			document.addEventListener("DOMContentLoaded", function() {
				var tabMessages = document.getElementById('tab-messages');
				var tabFiles = document.getElementById('tab-files');
				var contentMessages = document.getElementById('tab-content-messages');
				var contentFiles = document.getElementById('tab-content-files');
				tabMessages.addEventListener('click', function() {
					tabMessages.classList.add('active');
					tabFiles.classList.remove('active');
					contentMessages.style.display = 'block';
					contentFiles.style.display = 'none';
					tabMessages.style.background = '#256d4a';
					tabMessages.style.color = '#fff';
					tabFiles.style.background = '#eafaf1';
					tabFiles.style.color = '#256d4a';
				});
				tabFiles.addEventListener('click', function() {
					tabFiles.classList.add('active');
					tabMessages.classList.remove('active');
					contentFiles.style.display = 'block';
					contentMessages.style.display = 'none';
					tabFiles.style.background = '#256d4a';
					tabFiles.style.color = '#fff';
					tabMessages.style.background = '#eafaf1';
					tabMessages.style.color = '#256d4a';
				});
			});
		</script>
		<!-- Conteúdo da página community_detail -->
		<div class="container">
		  {% include 'components/sidebar.html' %}
				<!-- MAIN CONTENT -->
				<div class="main-content" style="margin: 0 auto; float: none; display: flex; flex-direction: column; align-items: center;">
					<div class="post-container" style="text-align:center; padding:0; overflow:visible;">
						<div style="background:#256d4a; height:120px; border-top-left-radius:10px; border-top-right-radius:10px; position:relative;">
							<!-- Foto da comunidade -->
							<img src="{{ community.get_community_picture_url }}" alt="Foto da comunidade" style="width: 120px; height: 120px; border-radius: 50%; border:4px solid #fff; position:absolute; left:50%; transform:translateX(-50%); bottom:-60px; box-shadow:0 2px 8px rgba(0,0,0,0.10); background:#fff;">
						</div>
						<!-- Nome da comunidade -->
						<div id="community-name" style="font-size:1.4em; font-weight:700; color:#222; margin-top:80px;">{{ community.name }}</div>
						<!-- Descrição da comunidade -->
						{% if community.description %}
							<div id="community-description" style="font-size:1.1em; color:#256d4a; margin-top:4px;">{{ community.description }}</div>
						{% endif %}

						<!-- Abas de Mensagens e Compartilhamento -->
						<div style="margin-top:32px;">
							<div style="display:flex; justify-content:center; gap:16px;">
								<button id="tab-messages" class="tab-btn active" style="padding:10px 24px; border:none; border-radius:8px 8px 0 0; background:#256d4a; color:#fff; font-weight:600; cursor:pointer;">Mensagens</button>
								<button id="tab-files" class="tab-btn" style="padding:10px 24px; border:none; border-radius:8px 8px 0 0; background:#eafaf1; color:#256d4a; font-weight:600; cursor:pointer;">Arquivos</button>
							</div>
							<div id="tab-content-messages" class="tab-content" style="background:#fafafa; border-radius:0 0 8px 8px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:24px;">
											<!-- Conteúdo de mensagens entre membros -->
											<h4 style="color:#256d4a; margin-bottom:12px;">Mensagens entre membros</h4>
											{% if error %}
												<div style="background:#ffebee; color:#c62828; padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid #c62828;">
													{{ error }}
												</div>
											{% endif %}
											<div class="messages-main" style="background:#fff; border-radius:8px; min-height:300px; box-shadow:0 2px 8px rgba(0,0,0,0.07); display:flex; overflow:hidden; margin:0 auto; max-width:600px;">
															<div class="chat-area" style="flex:1; display:flex; flex-direction:column; background:#fff; min-width:0; min-height:500px;">
													<div class="chat-messages" id="chat-messages" style="flex:1; padding:22px; overflow-y:auto; background:#fff; display:flex; flex-direction:column; gap:12px; max-height:400px;">
														{% if community_messages %}
															{% for message in community_messages %}
																{% if message.user == request.user %}
																	<!-- My message -->
																	<div style="display:flex; flex-direction:column; align-items:flex-end;">
																		<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
																			<small style="font-size:0.85em; color:#666;">{{ message.created_at|date:"H:i" }}</small>
																			<span style="font-size:0.97em; color:#256d4a; font-weight:600;">Você</span>
																		</div>
																		<div class="message me" style="max-width:70%; padding:10px 16px; border-radius:18px; font-size:1em; background:#256d4a; color:#fff; align-self:flex-end; box-shadow:0 1px 3px rgba(0,0,0,0.04);">
																			{% if message.body %}
																				{{ message.body }}
																			{% endif %}
																			{% if message.pdf %}
																				<div style="margin-top:8px;">
																					<a href="{{ message.pdf.url }}" target="_blank" style="color:#fff; text-decoration:underline;">
																						{% if message.file_type == '.pdf' %}📄
																						{% elif message.file_type in '.jpg,.jpeg,.png,.gif' %}🖼️
																						{% elif message.file_type in '.doc,.docx' %}📄
																						{% else %}📎{% endif %} {{ message.filename }}
																					</a>
																				</div>
																			{% endif %}
																		</div>
																	</div>
																{% else %}
																	<!-- Other user's message -->
																	<div style="display:flex; flex-direction:column; align-items:flex-start;">
																		<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
																			<span style="font-size:0.97em; color:#256d4a; font-weight:600;">{{ message.user.fullname }}</span>
																			<small style="font-size:0.85em; color:#666;">{{ message.created_at|date:"H:i" }}</small>
																		</div>
																		<div class="message" style="max-width:70%; padding:10px 16px; border-radius:18px; font-size:1em; background:#eafaf1; color:#222; align-self:flex-start; box-shadow:0 1px 3px rgba(0,0,0,0.04);">
																			{% if message.body %}
																				{{ message.body }}
																			{% endif %}
																			{% if message.pdf %}
																				<div style="margin-top:8px;">
																					<a href="{{ message.pdf.url }}" target="_blank" style="color:#256d4a; text-decoration:underline;">
																						{% if message.file_type == '.pdf' %}📄
																						{% elif message.file_type in '.jpg,.jpeg,.png,.gif' %}🖼️
																						{% elif message.file_type in '.doc,.docx' %}📄
																						{% else %}📎{% endif %} {{ message.filename }}
																					</a>
																				</div>
																			{% endif %}
																		</div>
																	</div>
																{% endif %}
															{% endfor %}
														{% else %}
															<div style="text-align:center; color:#888; padding:40px;">
																<p>Seja o primeiro a enviar uma mensagem nesta comunidade! 💬</p>
															</div>
														{% endif %}
													</div>
													<div class="chat-input-area" style="padding:16px 22px; border-top:1px solid #e0e0e0; background:#fafafa;">
														<form id="message-form" method="post" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center;">
															{% csrf_token %}
															<input type="hidden" name="community_id" value="{{ community.id }}">
															<input type="text" name="message_text" id="message-input" placeholder="Digite uma mensagem..." style="flex:1; padding:10px 16px; border-radius:18px; border:1px solid #e0e0e0; font-size:1em; outline:none;">
															
															<!-- File upload button -->
															<label for="file-input" style="cursor:pointer; padding:8px; border-radius:50%; background:#f0f0f0; display:flex; align-items:center; justify-content:center; width:36px; height:36px; transition:background 0.2s;">
																<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#256d4a" stroke-width="2">
																	<path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49"/>
																</svg>
															</label>
															<input type="file" id="file-input" name="message_file" style="display:none;" accept="image/*,application/pdf,.doc,.docx,.txt">
															
															<button type="submit" style="background:#256d4a; color:#fff; border:none; border-radius:18px; padding:10px 22px; font-weight:600; cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='#1e5a3a'" onmouseout="this.style.background='#256d4a'">Enviar</button>
														</form>
													</div>
												</div>
											</div>
							</div>
							<div id="tab-content-files" class="tab-content" style="display:none; background:#fafafa; border-radius:0 0 8px 8px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:24px;">
								<!-- Conteúdo de compartilhamento de arquivos -->
								<h4 style="color:#256d4a; margin-bottom:12px;">Arquivos Compartilhados</h4>
								
								<div class="messages-main" style="background:#fff; border-radius:8px; min-height:300px; box-shadow:0 2px 8px rgba(0,0,0,0.07); display:flex; overflow:hidden; margin:0 auto; max-width:600px;">
									<div class="chat-area" style="flex:1; display:flex; flex-direction:column; background:#fff; min-width:0; min-height:400px;">
										<div class="chat-messages" style="flex:1; padding:22px; overflow-y:auto; background:#fff; display:flex; flex-direction:column; gap:12px; max-height:400px;">
											{% if community_files %}
												{% for message in community_files %}
													{% if message.pdf %}
														{% if message.user == request.user %}
															<!-- My file message -->
															<div style="display:flex; flex-direction:column; align-items:flex-end;">
																<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
																	<small style="font-size:0.85em; color:#666;">{{ message.created_at|date:"H:i" }}</small>
																	<span style="font-size:0.97em; color:#256d4a; font-weight:600;">Você</span>
																</div>
																<div class="message me" style="max-width:70%; padding:10px 16px; border-radius:18px; font-size:1em; background:#256d4a; color:#fff; align-self:flex-end; box-shadow:0 1px 3px rgba(0,0,0,0.04);">
																	{% if message.body %}
																		{{ message.body }}
																	{% endif %}
																	<div style="margin-top:8px;">
																		<a href="{{ message.pdf.url }}" target="_blank" style="color:#fff; text-decoration:underline;">
																			{% if message.file_type == '.pdf' %}📄
																			{% elif message.file_type in '.jpg,.jpeg,.png,.gif' %}🖼️
																			{% elif message.file_type in '.doc,.docx' %}📄
																			{% else %}📎{% endif %} {{ message.filename }}
																		</a>
																	</div>
																</div>
															</div>
														{% else %}
															<!-- Other user's file message -->
															<div style="display:flex; flex-direction:column; align-items:flex-start;">
																<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
																	<span style="font-size:0.97em; color:#256d4a; font-weight:600;">{{ message.user.fullname }}</span>
																	<small style="font-size:0.85em; color:#666;">{{ message.created_at|date:"H:i" }}</small>
																</div>
																<div class="message" style="max-width:70%; padding:10px 16px; border-radius:18px; font-size:1em; background:#eafaf1; color:#222; align-self:flex-start; box-shadow:0 1px 3px rgba(0,0,0,0.04);">
																	{% if message.body %}
																		{{ message.body }}
																	{% endif %}
																	<div style="margin-top:8px;">
																		<a href="{{ message.pdf.url }}" target="_blank" style="color:#256d4a; text-decoration:underline;">
																			{% if message.file_type == '.pdf' %}📄
																			{% elif message.file_type in '.jpg,.jpeg,.png,.gif' %}🖼️
																			{% elif message.file_type in '.doc,.docx' %}📄
																			{% else %}�{% endif %} {{ message.filename }}
																		</a>
																	</div>
																</div>
															</div>
														{% endif %}
													{% endif %}
												{% endfor %}
											{% else %}
												<div style="text-align: center; color: #888; padding: 40px;">
													<div style="font-size: 48px; margin-bottom: 16px;">📁</div>
													<div style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;">Nenhum arquivo compartilhado ainda</div>
													<div style="font-size: 0.95em;">Os arquivos enviados pelos membros aparecerão aqui</div>
												</div>
											{% endif %}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
		
				</div>
				<!-- RIGHT SIDEBAR -->
				<div class="right-sidebar">
					<h3 style="color:#256d4a; margin-bottom:18px;">Membros da Comunidade</h3>
						{% if community.members.all %}
							<ul style="list-style:none; padding:0;">
								{% for member in community.members.all %}
									<li style="margin-bottom:18px; display:flex; align-items:center;">
										<img src="{{ member.get_profile_picture_url }}" alt="Foto de perfil" style="width:40px; height:40px; border-radius:50%; margin-right:12px; object-fit:cover;">
										<div>
											<div style="font-weight:600; color:#256d4a;">{{ member.fullname }}</div>
											{% if member.institution %}
												<div style="font-size:0.95em; color:#555;">{{ member.institution }}</div>
											{% endif %}
										</div>
									</li>
								{% endfor %}
							</ul>
						{% else %}
							<p style="color:#888;">Nenhum membro encontrado.</p>
						{% endif %}

						<hr style="margin:18px 0;">
						<div style="display:flex; align-items:center; justify-content:space-between;">
											<span style="font-weight:600; color:#256d4a;">Convidar pessoas que você segue</span>
											<button id="invite-btn" style="background:#28a745; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:1.5em; cursor:pointer; display:flex; align-items:center; justify-content:center;">+</button>
	<!-- Script para botão de convite -->
						</div>
						<div id="invite-list" style="display:none; margin-top:12px;">
							{% if possible_invites %}
								<ul style="list-style:none; padding:0;">
									{% for user in possible_invites %}
										<li style="margin-bottom:14px; display:flex; align-items:center;">
											<img src="{{ user.get_profile_picture_url }}" alt="Foto de perfil" style="width:32px; height:32px; border-radius:50%; margin-right:10px; object-fit:cover;">
											<span style="font-weight:500; color:#256d4a; margin-right:8px;">{{ user.fullname }}</span>
											<form method="get" action="">
												<input type="hidden" name="invite" value="{{ user.id }}">
												<button type="submit" style="background:#256d4a; color:#fff; border:none; border-radius:4px; padding:4px 10px; font-size:0.95em; cursor:pointer;">Convidar</button>
											</form>
										</li>
									{% endfor %}
								</ul>
							{% else %}
								<p style="color:#888;">Você já convidou todos que segue.</p>
							{% endif %}
						</div>
				</div>
		</div>
		<script src="{% static 'js/home.js' %}"></script>
		<script>
			// Message form functionality
			document.addEventListener("DOMContentLoaded", function() {
				const messageForm = document.getElementById('message-form');
				const messageInput = document.getElementById('message-input');
				const chatMessages = document.getElementById('chat-messages');
				const fileInput = document.getElementById('file-input');
				
				// Auto-scroll to bottom of messages
				function scrollToBottom() {
					chatMessages.scrollTop = chatMessages.scrollHeight;
				}
				
				// Initial scroll to bottom
				scrollToBottom();
				
				// File input change handler
				fileInput.addEventListener('change', function() {
					const fileName = this.files[0] ? this.files[0].name : '';
					if (fileName) {
						messageInput.placeholder = `Arquivo selecionado: ${fileName}`;
						messageInput.style.fontStyle = 'italic';
						messageInput.style.color = '#256d4a';
					} else {
						messageInput.placeholder = 'Digite uma mensagem...';
						messageInput.style.fontStyle = 'normal';
						messageInput.style.color = '';
					}
				});
				
				// Form submission handler
				if (messageForm) {
					messageForm.addEventListener('submit', function(e) {
						const messageText = messageInput.value.trim();
						const selectedFile = fileInput.files[0];
						
						if (!messageText && !selectedFile) {
							e.preventDefault();
							alert('Por favor, digite uma mensagem ou selecione um arquivo.');
							return;
						}
						
						// Let the form submit normally for now
						// Could be enhanced with AJAX later
					});
				}
				
				// Enhanced file upload icon hover effect
				const fileLabel = document.querySelector('label[for="file-input"]');
				if (fileLabel) {
					fileLabel.addEventListener('mouseenter', function() {
						this.style.background = '#e0e0e0';
					});
					fileLabel.addEventListener('mouseleave', function() {
						this.style.background = '#f0f0f0';
					});
				}
			});
			
			document.addEventListener("DOMContentLoaded", function() {
				var inviteBtn = document.getElementById('invite-btn');
				var inviteList = document.getElementById('invite-list');
				var hasInvites = Number("{{ possible_invites|length }}");
				inviteBtn.addEventListener('click', function() {
					if (hasInvites > 0) {
						inviteList.classList.toggle('show');
						inviteList.style.display = inviteList.classList.contains('show') ? 'block' : 'none';
					} else {
						if (typeof toastr !== 'undefined') {
							toastr.options = {
								"closeButton": true,
								"progressBar": true,
								"positionClass": "toast-top-center"
							};
							toastr.info("Você não segue ninguém para convidar.");
						} else {
							alert("Você não segue ninguém para convidar.");
						}
					}
				});
			});
		</script>
</body>
</html>
