{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'styles/home.css' %}">
<link rel="stylesheet" href="{% static 'styles/conexao.css' %}">
<link rel="stylesheet" href="{% static 'styles/artigos.css' %}">
<!-- Boxicons for icons used in chat input -->
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<style>

  body { overflow: auto; }

  .container { padding: 13px 5%; }
  /* EspaÃ§amento entre colunas */
  .container { gap: 24px; }
  .left-sidebar { flex-basis: 20% !important; }
  .main-content { flex-basis: 60% !important; }
  .right-sidebar { flex-basis: 20% !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; }
  .right-sidebar { margin-left: 24px; }

  /* Mensagens como cards */
  .chat-messages { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .message { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); max-width: 75%; align-self: flex-start; line-height: 1.35; color: #222; }
  .message.me { background: #eafaf1; border-color: rgba(40, 167, 69, 0.25); align-self: flex-end; }
  /* Opcional: ajustar espaÃ§amento interno do chat quando hÃ¡ input fixo */
  .messages-main .chat-messages { padding-bottom: 70px; }
</style>
{% endblock %}
{% block content %}
<!-- Notification bar for invite feedback -->
<div id="invite-notification" style="display:none; position:fixed; top:0; left:0; right:0; z-index:9999; background:#256d4a; color:#fff; padding:14px 0; text-align:center; font-size:1.08em; font-weight:500; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
  <span id="invite-notification-text"></span>
</div>
<!-- Navbar -->
<nav>
    <div class="nav-left">
      <a href="{% url 'feed:artigos' %}"><img src="{% static 'assets/img/logo.png' %}" class="logo"></a>
      <ul>
        <li><img src="{% static 'assets/img/notification.png' %}"></li>
        <li><a href="{% url 'feed:mensagens' %}"><img src="{% static 'assets/img/inbox.png' %}" alt="Mensagens" style="cursor:pointer;"></a></li>
      </ul>
    </div>
    <div class="nav-right">
      <div class="nav-user-icon online" onclick="settingsMenuToggle()">
        <img src="{{ request.user.get_profile_picture_url }}">
      </div>
      <div class="settings-menu">
        <div id="dark-btn"><span></span></div>
        <div class="settings-menu-inner">
          <div class="user-profile">
            <img src="{{ request.user.get_profile_picture_url }}">
            <div>
              <p>{{ request.user.fullname }}</p>
              <a href="{% url 'feed:perfil' %}">Ver Perfil</a>
            </div>
          </div>
          <hr>
          <div class="user-profile">
            <img src="{% static 'assets/img/feedback.png' %}">
            <div>
              <p>Nos dÃª seu feedback</p>
              <a href="#">Ajude a melhorar nosso site</a>
            </div>
          </div>
          <hr>
          <div class="settings-links">
            <img src="{% static 'assets/img/setting.png' %}" class="settings-icon">
            <a href="{% url 'feed:settings' %}">ConfiguraÃ§Ã£o & Privacidade <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
          </div>
          <div class="settings-links">
            <img src="{% static 'assets/img/help.png' %}" class="settings-icon">
            <a href="#">Ajuda <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
          </div>
          <div class="settings-links">
            <img src="{% static 'assets/img/logout.png' %}" class="settings-icon">
            <a href="{% url 'logout' %}">Sair <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
          </div>
        </div>
      </div>
    </div>
  </nav>

<div class="container">
    <!-- LEFT SIDEBAR -->
    <div class="left-sidebar">
      <style>
        .imp-links a {
          display: flex;
          align-items: center;
          padding: 10px 16px;
          border-left: 4px solid transparent;
          color: #256d4a !important;
          text-decoration: none;
          font-weight: 500;
          background: none;
          transition: background 0.2s, border-color 0.2s, color 0.2s;
        }
        .imp-links a.active {
          background: #eafaf1;
          border-left: 4px solid #28a745;
          color: #28a745 !important;
        }
        .imp-links a img {
          margin-right: 10px;
        }
      </style>
      <div class="imp-links">
        <a href="{% url 'feed:artigos' %}" class="{% if request.resolver_match.url_name == 'artigos' %}active{% endif %}"><img src="{% static 'assets/img/newspaper.png' %}"> Artigos CientÃ­ficos</a>
        <a href="{% url 'feed:conexao' %}" class="{% if request.resolver_match.url_name == 'conexao' %}active{% endif %}"><img src="{% static 'assets/img/friends.png' %}"> ConexÃµes</a>
        <a href="{% url 'feed:community' %}" class="active"><img src="{% static 'assets/img/people.png' %}"> Comunidades</a>
      </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="messages-main">
      <!-- MEMBERS LIST -->
      <div class="members-list">
        <div style="padding: 18px 18px 0 18px; background: #fafafa; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
          <h4 style="margin: 0; color: #256d4a;">Membros ({{ community.members.count }})</h4>
          <button id="invite-members-btn" class="plus-btn" title="Adicionar membros">+</button>
        </div>
        {% for member in community.members.all %}
          <div class="member-item">
            <img src="{{ member.get_profile_picture_url }}" alt="{{ member.fullname }}">
            <div class="member-info">
              <div class="member-name">{{ member.fullname }}</div>
              <div class="member-status">{{ member.research_area|default:'Membro' }}</div>
            </div>
          </div>
        {% empty %}
          <div style="padding: 20px; color: #888;">Nenhum membro ainda.</div>
        {% endfor %}
      </div>
      
      <!-- CHAT AREA -->
      <div class="chat-area">
        <div class="chat-header">
          <div class="community-info">
            <img src="{{ community.get_community_picture_url }}" alt="{{ community.name }}">
            <div>
              <div class="chat-name">{{ community.name }}</div>
              <div style="font-size: 0.9em; color: #888;">{{ community.description|default:'Comunidade' }}</div>
            </div>
          </div>
        </div>
        
        <div class="chat-messages">
          {% if error %}<div style="color: #dc3545; margin-bottom: 10px;">{{ error }}</div>{% endif %}
          {% for msg in messages %}
            <div class="message{% if msg.user == request.user %} me{% endif %}">
              {% if msg.user != request.user %}
                <div class="message-author">{{ msg.user.fullname }}</div>
              {% endif %}
              {% if msg.body %}
                <div class="message-text">{{ msg.body }}</div>
              {% endif %}
              {% if msg.has_pdf %}
                <div class="pdf-attachment" style="margin-top: 8px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2em;">ðŸ“„</span>
                    <div style="flex: 1;">
                      <div style="font-weight: 600; font-size: 0.9em;">{{ msg.pdf_filename }}</div>
                      {% if msg.pdf_size %}<div style="font-size: 0.8em; opacity: 0.8;">{{ msg.pdf_size }}</div>{% endif %}
                    </div>
                    <a href="{{ msg.get_pdf_url }}" target="_blank" style="background: rgba(255,255,255,0.2); color: inherit; text-decoration: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600;">Abrir</a>
                  </div>
                </div>
              {% endif %}
              <div class="message-time" style="font-size: 0.75em; opacity: 0.7; margin-top: 4px;">
                {{ msg.created_at|date:"H:i" }}
              </div>
            </div>
          {% empty %}
            <div style="color:#888; text-align: center; margin-top: 50px;">Nenhuma mensagem ainda. Seja o primeiro a enviar uma mensagem!</div>
          {% endfor %}
        </div>
        
        <div class="chat-input-area">
          <div id="pdf-preview" style="display: none; padding: 8px 12px; background: #f0f0f0; border-radius: 8px; margin-bottom: 8px; font-size: 0.9em;">
            <span style="font-weight: 600;">ðŸ“„ PDF selecionado: </span>
            <span id="pdf-name"></span>
            <button type="button" id="remove-pdf" style="background: none; border: none; color: #dc3545; cursor: pointer; margin-left: 8px;">âœ•</button>
          </div>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="text" name="message" class="chat-input" placeholder="Digite uma mensagem para a comunidade...">
            <label for="pdf-upload" style="cursor:pointer; color:#28a745; font-weight:bold; margin-right:8px; transition: color 0.3s;" title="Anexar PDF">ðŸ“Ž
              <input type="file" id="pdf-upload" name="pdf" accept="application/pdf" style="display:none;">
            </label>
            <button type="submit" class="send-btn">Enviar</button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Right Sidebar invisible -->
    <div class="right-sidebar" style="visibility:hidden; opacity:0; pointer-events:none;"></div>
  </div>

  <!-- Modal para convidar membros -->
  <div id="invite-modal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 95%; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: relative;">
      <span class="close-modal" id="close-invite-modal" style="color: #aaa; font-size: 24px; font-weight: bold; position: absolute; top: 10px; right: 20px; cursor: pointer;">&times;</span>
      <h4 style="margin-top: 0; color: #256d4a;">Convidar pessoas que vocÃª segue</h4>
      <div style="max-height: 300px; overflow-y: auto;">
        {% for user in possible_invites %}
          <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
            <img src="{{ user.get_profile_picture_url }}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #256d4a;">{{ user.fullname }}</div>
              <div style="color: #888; font-size: 0.9em;">{{ user.research_area|default:'Pesquisador' }}</div>
            </div>
            <form method="get" style="display:inline;">
              <input type="hidden" name="invite" value="{{ user.id }}">
              <button type="submit" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Convidar</button>
            </form>
          </div>
        {% empty %}
          <div style="padding: 20px; color: #888; text-align: center;">VocÃª jÃ¡ convidou todos que segue.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <script src="{% static 'js/home.js' %}"></script>
    <!-- Modal para convidar membros -->
=======
{% block extra_head %}
<link rel="stylesheet" href="{% static 'styles/home.css' %}">
<link rel="stylesheet" href="{% static 'styles/conexao.css' %}">
<link rel="stylesheet" href="{% static 'styles/artigos.css' %}">
<!-- Boxicons for icons used in chat input -->
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<style>

  body { overflow: auto; }

  .container { padding: 13px 5%; }
  /* EspaÃ§amento entre colunas */
  .container { gap: 24px; }
  .left-sidebar { flex-basis: 20% !important; }
  .main-content { flex-basis: 60% !important; }
  .right-sidebar { flex-basis: 20% !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; }
  .right-sidebar { margin-left: 24px; }

  /* Mensagens como cards */
  .chat-messages { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .message { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); max-width: 75%; align-self: flex-start; line-height: 1.35; color: #222; }
  .message.me { background: #eafaf1; border-color: rgba(40, 167, 69, 0.25); align-self: flex-end; }
  /* Opcional: ajustar espaÃ§amento interno do chat quando hÃ¡ input fixo */
  .messages-main .chat-messages { padding-bottom: 70px; }
</style>
{% endblock %}

{% block content %}
<!-- Notification bar for invite feedback -->
<div id="invite-notification" style="display:none; position:fixed; top:0; left:0; right:0; z-index:9999; background:#256d4a; color:#fff; padding:14px 0; text-align:center; font-size:1.08em; font-weight:500; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
  <span id="invite-notification-text"></span>
</div>
<!-- Navbar -->
<nav>
  <div class="nav-left">
    <a href="{% url 'feed:artigos' %}"><img src="{% static 'assets/img/logo.png' %}" class="logo"></a>
    <ul>
      <li><img src="{% static 'assets/img/notification.png' %}"></li>
      <li><a href="{% url 'feed:mensagens' %}"><img src="{% static 'assets/img/inbox.png' %}" alt="Mensagens" style="cursor:pointer;"></a></li>
    </ul>
  </div>
  <div class="nav-right">
    <form class="search-box" method="get" action="">
      <img src="{% static 'assets/img/search.png' %}">
      <input type="text" name="q" placeholder="Pesquisar comunidades" value="">
    </form>
    <div class="nav-user-icon online" onclick="settingsMenuToggle()">
      <img src="{{ request.user.get_profile_picture_url }}">
    </div>
    <div class="settings-menu">
      <div id="dark-btn"><span></span></div>
      <div class="settings-menu-inner">
        <div class="user-profile">
          <img src="{{ request.user.get_profile_picture_url }}">
          <div>
            <p>{{ request.user.fullname }}</p>
            <a href="{% url 'feed:perfil' %}">Ver Perfil</a>
          </div>
        </div>
        <hr>
        <div class="user-profile">
          <img src="{% static 'assets/img/feedback.png' %}">
          <div>
            <p>Nos dÃª seu feedback</p>
            <a href="#">Ajude a melhorar nosso site</a>
          </div>
        </div>
        <hr>
        <div class="settings-links">
          <img src="{% static 'assets/img/setting.png' %}" class="settings-icon">
          <a href="{% url 'feed:settings' %}">ConfiguraÃ§Ã£o & Privacidade <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
        </div>
        <div class="settings-links">
          <img src="{% static 'assets/img/help.png' %}" class="settings-icon">
          <a href="#">Ajuda <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
        </div>
        <div class="settings-links">
          <img src="{% static 'assets/img/logout.png' %}" class="settings-icon">
          <a href="{% url 'logout' %}">Sair <img src="{% static 'assets/img/arrow.png' %}" width="10px"></a>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="container">
  <!-- Left Sidebar -->
  <div class="left-sidebar">
    <style>
      .imp-links a {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        border-left: 4px solid transparent;
        color: #256d4a !important;
        text-decoration: none;
        font-weight: 500;
        background: none;
        transition: background 0.2s, border-color 0.2s, color 0.2s;
      }
      .imp-links a.active {
        background: #eafaf1;
        border-left: 4px solid #28a745;
        color: #28a745 !important;
      }
      .imp-links a img {
        margin-right: 10px;
      }
    </style>
    <div class="imp-links">
      <a href="{% url 'feed:artigos' %}" class="{% if request.resolver_match.url_name == 'artigos' %}active{% endif %}"><img src="{% static 'assets/img/newspaper.png' %}"> Artigos CientÃ­ficos</a>
      <a href="{% url 'feed:conexao' %}" class="{% if request.resolver_match.url_name == 'conexao' %}active{% endif %}"><img src="{% static 'assets/img/friends.png' %}"> ConexÃµes</a>
      <a href="{% url 'feed:community' %}" class="{% if request.resolver_match.url_name == 'community' %}active{% endif %}"><img src="{% static 'assets/img/people.png' %}"> Comunidades</a>
    </div>
  </div>

  <!-- ConteÃºdo principal -->
  <div class="main-content">
    <!-- Banner da comunidade centralizado -->
    <div style="background:#256d4a; height:120px; border-top-left-radius:10px; border-top-right-radius:10px; position:relative; margin-bottom:40px; display:flex; justify-content:center; align-items:flex-end;">
      <img src="{{ community.get_community_picture_url }}" alt="Foto da comunidade" style="width:120px; height:120px; border-radius:50%; border:4px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.10); background:#fff; margin-bottom:-60px;">
    </div>
    <div style="text-align:center; margin-top:80px; margin-bottom:32px;">
      <div style="font-size:1.4em; font-weight:700; color:#222;">{{ community.name }}</div>
      <div style="font-size:1.1em; color:#256d4a; margin-top:4px;">{{ community.description }}</div>
    </div>
      <!-- Tabs navigation -->
  <div class="tabs" style="display:flex; gap:10px; border-bottom:1px solid #cfcfcf; margin-bottom:16px;">
      <button class="tab-btn active" data-tab="messages" style="background:#fff; border:1px solid #e0e0e0; border-bottom:none; padding:8px 12px; border-top-left-radius:6px; border-top-right-radius:6px; color:#256d4a; font-weight:600;">Mensagens</button>
      <button class="tab-btn" data-tab="articles" style="background:#fff; border:1px solid #e0e0e0; border-bottom:none; padding:8px 12px; border-top-left-radius:6px; border-top-right-radius:6px; color:#256d4a; font-weight:600;">Artigos</button>
  </div>

      <!--Mensagens -->
      <div id="tab-messages" class="tab-content" style="display:block; position:relative; min-height:400px;">
        <div class="chat-messages" style="padding-bottom:70px;">
          {% if messages %}
            {% for msg in messages %}
              <div class="message{% if msg.user.id == request.user.id %} me{% endif %}">
                {% if msg.body %}{{ msg.body }}{% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div style="color:#888; text-align:center; margin-top:20px; font-size:1.05em;">Nenhuma mensagem ainda.</div>
          {% endif %}
        </div>
        <form method="post" enctype="multipart/form-data" class="chat-input-area" style="position:absolute; left:0; right:0; bottom:0; padding:12px 18px; background:#f8f8f8; border-top:1px solid #e0e0e0; display:flex; gap:10px; align-items:center;">
          {% csrf_token %}
          <input type="text" name="message" placeholder="Digite sua mensagem..." style="flex:1; padding:10px 14px; border-radius:6px; border:1px solid #e0e0e0; font-size:1em;">
          <label for="chat-pdf" style="background:#fff; color:#256d4a; border:1px solid #e0e0e0; border-radius:6px; padding:10px 12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
            <i class='bx bx-paperclip'></i>
          </label>
          <input id="chat-pdf" type="file" name="pdf" accept="application/pdf" style="display:none;">
          <button type="submit" style="background:#28a745; color:#fff; border:none; border-radius:6px; padding:10px 18px; font-weight:600; cursor:pointer;">Enviar</button>
        </form>
      </div>

      <!--Artigos compartilhados-->
      <div id="tab-articles" class="tab-content" style="display:none;">
        <div class="post-container">
          <h3>Artigos compartilhados</h3>
          {% if community_articles %}
            <ul style="list-style:none; padding:0;">
              {% for article in community_articles %}
                <li style="margin-bottom:12px; padding:12px; border:1px solid #e0e0e0; border-radius:8px; background:#fafafa;">
                  <div style="font-weight:600; color:#256d4a;">{{ article.title }}</div>
                  <div style="color:#555;">{{ article.research_area }}</div>
                  {% if article.description %}
                    <div style="color:#333; font-size:0.95em; margin-top:6px;">{{ article.description|truncatechars:220 }}</div>
                  {% endif %}
                  {% if article.pdf %}
                    <a href="{{ article.pdf.url }}" target="_blank" style="color:#28a745; text-decoration:underline;">Ver PDF</a>
                  {% endif %}
                  <div style="font-size:0.9em; color:#777; margin-top:4px;">Compartilhado por {{ article.user.fullname }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p style="color:#888;">Nenhum artigo compartilhado ainda.</p>
          {% endif %}
        </div>
      </div>
          modal.style.display = 'flex'; 
          modal.style.alignItems = 'center'; 
          modal.style.justifyContent = 'center'; 
        };
        closeModal.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
      }
    });
  </script>
</body>
</html>
=======
  (function() {
    var btns = document.querySelectorAll('.tab-btn');
    var tabs = { messages: document.getElementById('tab-messages'), articles: document.getElementById('tab-articles') };
    btns.forEach(function(btn){
      btn.addEventListener('click', function(){
        btns.forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        var t = btn.getAttribute('data-tab');
        if (t === 'messages') {
          tabs.messages.style.display = 'block';
          tabs.articles.style.display = 'none';
        } else {
          tabs.messages.style.display = 'none';
          tabs.articles.style.display = 'block';
        }
      });
    });
  })();
  document.getElementById('invite-members-btn').onclick = function() {
  var btn = document.getElementById('invite-members-btn');
  var countAttr = btn ? btn.getAttribute('data-count') : '0';
  var hasInvites = parseInt(countAttr || '0', 10) > 0;
    if (!hasInvites) {
      var notif = document.getElementById('invite-notification');
      var notifText = document.getElementById('invite-notification-text');
      notifText.textContent = 'VocÃª nÃ£o tem pessoas que segue para convidar.';
      notif.style.display = 'block';
      setTimeout(function(){ notif.style.display = 'none'; }, 3500);
      return;
    }
    // Open modal with search
    document.getElementById('invite-modal').style.display = 'block';
    var searchInput = document.getElementById('invite-search');
    var list = document.getElementById('invite-list');
    searchInput.oninput = function(){
      var q = this.value.trim().toLowerCase();
      Array.prototype.forEach.call(list.querySelectorAll('li'), function(li){
        var name = li.getAttribute('data-name');
        li.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
      });
    };
  };
  document.getElementById('close-invite-modal').onclick = function() {
    document.getElementById('invite-modal').style.display = 'none';
  };
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/home.js' %}"></script>
{% endblock %}
>>>>>>> Stashed changes
