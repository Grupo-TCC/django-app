{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil - Innovator</title>
  <link rel="stylesheet" href="{% static 'styles/home.css' %}">
  <style>
    /* For√ßa o modal a cobrir tudo, inclusive overlays de artigos */
    #profile-img-modal {
      display: none;
      position: fixed !important;
      z-index: 2147483647 !important;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.88);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #profile-img-modal[style*="display: flex"] {
      display: flex !important;
    }
    #profile-img-modal img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.25);
      display: block;
      margin: auto;
      position: relative;
      z-index: 2147483648;
    }
    body.modal-open {
      overflow: hidden !important;
    }
  </style>
</head>
<body>
  {% include 'components/topbar.html' %}

  <div class="container">
    {% include 'components/sidebar.html' %}

    <!-- MAIN CONTENT -->
    <div class="main-content" style="margin: 0 auto; float: none; display: flex; flex-direction: column; align-items: center;">
      <!-- Bloco de perfil restaurado -->
      <div class="post-container" style="text-align:center; padding:0; overflow:visible;">
        <!-- Capa verde escuro -->
        <div style="background:#256d4a; height:120px; border-top-left-radius:10px; border-top-right-radius:10px; position:relative;">
          <!-- Foto de perfil -->
          <img src="{{ profile_user.get_profile_picture_url }}" alt="Foto de perfil" style="width: 120px; height: 120px; border-radius: 50%; border:4px solid #fff; position:absolute; left:50%; transform:translateX(-50%); bottom:-60px; box-shadow:0 2px 8px rgba(0,0,0,0.10); background:#fff;">
          <img src="{{ profile_user.get_profile_picture_url }}" alt="Foto de perfil" id="profile-header-img" style="width: 120px; height: 120px; border-radius: 50%; border:4px solid #fff; position:absolute; left:50%; transform:translateX(-50%); bottom:-60px; box-shadow:0 2px 8px rgba(0,0,0,0.10); background:#fff; cursor:pointer;">

          <!-- Modal para imagem inteira -->

        </div>
        <!-- Nome do usu√°rio -->
        <div id="profile-name" style="font-size:1.4em; font-weight:700; color:#222; margin-top:80px;">{{ profile_user.fullname }}</div>
        <!-- T√≠tulo e institui√ß√£o -->
        <div id="profile-title" style="font-size:1.1em; color:#256d4a; margin-top:4px;">
          {% if profile_user.research_area %}
            {{ profile_user.research_area }}
          {% else %}
            <span style="color:#bbb;">adicione um t√≠tulo</span>
          {% endif %}
        </div>
        <div id="profile-university" style="font-size:1em; color:#555; margin-bottom:10px;">
          {% if profile_user.institution %}
            {{ profile_user.institution }}
          {% else %}
            <span style="color:#bbb;">adicione institui√ß√£o</span>
          {% endif %}
        </div>
        <!-- Localiza√ß√£o -->
        {% if profile_user.cidade or profile_user.estado %}
        <div id="profile-location" style="font-size:0.9em; color:#666; margin-bottom:10px;">
          üìç {% if profile_user.cidade %}{{ profile_user.cidade }}{% endif %}{% if profile_user.cidade and profile_user.estado %}, {% endif %}{% if profile_user.estado %}{{ profile_user.estado }}{% endif %}
        </div>
        {% endif %}
      </div>

      <div class="post-container" style="margin-top:32px;">
        
        
        <!-- Articles Section -->
        {% if user_articles %}
          <h3 style="color:#256d4a; margin-top:20px; margin-bottom:15px; font-size:1.2em;">üìÑ Artigos ({{ user_articles|length }})</h3>
          <ul style="list-style:none;padding:0;">
            {% for article in user_articles %}
              <li style="margin-bottom:18px; padding:16px; border:1px solid #e0e0e0; border-radius:8px; background:#fafafa; position:relative;">
                <div style="font-size:1.1em; font-weight:600; color:#256d4a;">{{ article.title }}</div>
                <div style="font-size:0.95em; color:#555; margin:4px 0 8px 0;">üìö {{ article.research_area }} ‚Ä¢ Qualis: {{ article.qualis_capes }}</div>
                {% if article.description %}
                  <div class="article-description" style="font-size:0.97em; color:#333; margin-bottom:8px; position:relative;">
                    <span class="desc-text" style="display:inline;">
                      {% if article.description|length > 220 %}
                        <span class="desc-short">{{ article.description|slice:':220' }}...</span>
                        <span class="desc-full" style="display:none;">{{ article.description }}</span>
                        <button class="desc-toggle" onclick="toggleDesc(this); return false;" style="background:none;border:none;color:#28a745;cursor:pointer;padding:0;">mais</button>
                      {% else %}
                        {{ article.description }}
                      {% endif %}
                    </span>
                  </div>
                {% endif %}
                {% if article.get_pdf_url %}
                <a href="{{ article.get_pdf_url }}" target="_blank" style="color:#28a745; font-weight:500; text-decoration:underline;">Ver PDF</a>
                {% else %}
                <span style="color: #888; font-style: italic;">PDF n√£o dispon√≠vel</span>
                {% endif %}
                <div style="font-size:0.9em; color:#888; margin-top:8px;">Publicado em {{ article.created_at|date:"d/m/Y" }}</div>
                {% if profile_user == request.user %}
                <form method="post" action="{% url 'feed:delete_article' article.id %}" style="position:absolute; top:12px; right:12px;">
                  {% csrf_token %}
                  <button type="submit" style="background:#fff; color:#d32f2f; border:1px solid #d32f2f; border-radius:4px; padding:2px 10px; font-size:13px; cursor:pointer;">Apagar</button>
                </form>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <!-- Translations Section -->
        {% if user_translations %}
          <h3 style="color:#256d4a; margin-top:25px; margin-bottom:15px; font-size:1.2em;">üé• Tradu√ß√µes de Conhecimento ({{ user_translations|length }})</h3>
          <ul style="list-style:none;padding:0;">
            {% for translation in user_translations %}
              <li style="margin-bottom:18px; padding:16px; border:1px solid #e0e0e0; border-radius:8px; background:#fff8dc; position:relative;">
                {% if profile_user == request.user %}
                <form method="post" action="{% url 'feed:delete_media_post' translation.id %}" style="position:absolute; top:12px; right:12px;">
                  {% csrf_token %}
                  <button type="submit" onclick="return confirm('Tem certeza de que deseja excluir esta tradu√ß√£o?')" style="background-color:#dc3545; color:white; border:none; border-radius:4px; padding:6px 10px; font-size:0.85em; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);">Apagar</button>
                </form>
                {% endif %}
                <div style="font-size:1.1em; font-weight:600; color:#256d4a;">{{ translation.title }}</div>
                <div style="font-size:0.95em; color:#555; margin:4px 0 8px 0;">üìö {{ translation.get_research_area_display }} ‚Ä¢ Tipo: {{ translation.get_media_types_display }}</div>
                {% if translation.description %}
                  <div class="translation-description" style="font-size:0.97em; color:#333; margin-bottom:8px; position:relative;">
                    <span class="desc-text" style="display:inline;">
                      {% if translation.description|length > 220 %}
                        <span class="desc-short">{{ translation.description|slice:':220' }}...</span>
                        <span class="desc-full" style="display:none;">{{ translation.description }}</span>
                        <button class="desc-toggle" onclick="toggleDesc(this); return false;" style="background:none;border:none;color:#28a745;cursor:pointer;padding:0;">mais</button>
                      {% else %}
                        {{ translation.description }}
                      {% endif %}
                    </span>
                  </div>
                {% endif %}
                <div style="font-size:0.95em; color:#28a745; margin-bottom:8px;">
                  üí∞ {{ translation.get_payment_type_display }}{% if translation.payment_type == 'paid' and translation.price %} - R$ {{ translation.price }}{% endif %}
                </div>
                <div style="font-size:0.9em; color:#888; margin-top:8px;">Publicado em {{ translation.created_at|date:"d/m/Y" }}</div>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <!-- Products Section -->
        {% if user_products %}
          <h3 style="color:#256d4a; margin-top:25px; margin-bottom:15px; font-size:1.2em;">üõçÔ∏è Produtos ({{ user_products|length }})</h3>
          <ul style="list-style:none;padding:0;">
            {% for product in user_products %}
              <li style="margin-bottom:18px; padding:16px; border:1px solid #e0e0e0; border-radius:8px; background:#fff8dc; position:relative;">
                {% if profile_user == request.user %}
                <form method="post" action="{% url 'feed:delete_product' product.id %}" style="position:absolute; top:12px; right:12px;">
                  {% csrf_token %}
                  <button type="submit" onclick="return confirm('Tem certeza de que deseja excluir este produto?')" style="background-color:#dc3545; color:white; border:none; border-radius:4px; padding:6px 10px; font-size:0.85em; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);">Apagar</button>
                </form>
                {% endif %}
                <div style="font-size:1.1em; font-weight:600; color:#256d4a;">{{ product.titulo }}</div>
                <div style="font-size:0.95em; color:#555; margin:4px 0 8px 0;">üìÇ {{ product.get_area_pesquisa_display }}</div>
                {% if product.descricao %}
                  <div class="product-description" style="font-size:0.97em; color:#333; margin-bottom:8px; position:relative;">
                    <span class="desc-text" style="display:inline;">
                      {% if product.descricao|length > 220 %}
                        <span class="desc-short">{{ product.descricao|slice:':220' }}...</span>
                        <span class="desc-full" style="display:none;">{{ product.descricao }}</span>
                        <button class="desc-toggle" onclick="toggleDesc(this); return false;" style="background:none;border:none;color:#28a745;cursor:pointer;padding:0;">mais</button>
                      {% else %}
                        {{ product.descricao }}
                      {% endif %}
                    </span>
                  </div>
                {% endif %}
                {% if product.link %}
                <a href="{{ product.link }}" target="_blank" style="color:#28a745; font-weight:500; text-decoration:underline;">Ver Produto</a>
                {% endif %}
                <div style="font-size:0.9em; color:#888; margin-top:8px;">Publicado em {{ product.created_at|date:"d/m/Y" }}</div>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <!-- Empty state -->
        {% if not user_articles and not user_translations and not user_products %}
          <p style="color:#888;">
            {% if profile_user == request.user %}
              Voc√™ ainda n√£o publicou nenhum conte√∫do. Comece publicando artigos, tradu√ß√µes de conhecimento ou produtos!
            {% else %}
              Este usu√°rio ainda n√£o publicou nenhum conte√∫do.
            {% endif %}
          </p>
        {% endif %}
      </div>
      <script>
      function toggleDesc(btn) {
        var card = btn.closest('.article-description');
        var shortDesc = card.querySelector('.desc-short');
        var fullDesc = card.querySelector('.desc-full');
        if (shortDesc.style.display !== 'none') {
          shortDesc.style.display = 'none';
          fullDesc.style.display = 'inline';
          btn.textContent = 'menos';
          btn.style.color = '#28a745';
        } else {
          shortDesc.style.display = 'inline';
          fullDesc.style.display = 'none';
          btn.textContent = 'mais';
          btn.style.color = '#28a745';
        }
      }

      // Modal da imagem de perfil
      document.addEventListener('DOMContentLoaded', function() {
        var img = document.getElementById('profile-header-img');
        var modal = document.getElementById('profile-img-modal');
        if (img && modal) {
          img.onclick = function() {
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
          };
          modal.onclick = function(e) {
            if (e.target === modal) {
              modal.style.display = 'none';
              document.body.classList.remove('modal-open');
            }
          };
        }
      });
      </script>
    </div>
    <!-- Fim main-content -->

    <!-- Right Sidebar invis√≠vel -->
    <div class="right-sidebar" style="visibility:hidden; opacity:0; pointer-events:none;"></div>
  </div>
  
  <!-- Modal para imagem inteira -->
  <div id="profile-img-modal" style="display:none; position:fixed; z-index:2147483647 !important; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.92); align-items:center; justify-content:center; flex-direction:column;">
    <img src="{{ profile_user.get_profile_picture_url }}" alt="Foto de perfil inteira" style="max-width:90vw; max-height:90vh; border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.25); display:block; margin:auto; position:relative; z-index:2147483648;">
  </div>
    <script src="{% static 'js/home.js' %}"></script>

    <!-- Cookie Consent Banner -->
    <div id="cookie-consent" style="display:none; position:fixed; bottom:16px; left:16px; right:16px; background:#fff; border:1px solid #ddd; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:10000; border-radius:8px; max-width:600px; margin:0 auto;">
        <div style="display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
            <div style="flex:1; font-size:14px; color:#333; line-height:1.4; min-width:300px;">
                <strong>üç™ Cookies e Privacidade</strong><br>
                Usamos cookies para melhorar sua experi√™ncia no InnovaSUS. Ao continuar navegando, voc√™ concorda com nossa pol√≠tica de cookies.
                <a href="https://www.kaspersky.com.br/resource-center/definitions/cookies" target="_blank" rel="noopener noreferrer" style="margin-left:8px; color:#256d4a; text-decoration:underline;">Saiba mais</a>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button id="cookie-accept-btn" style="background:#256d4a; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px; font-weight:500;">Aceitar</button>
                <button id="cookie-decline-btn" style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px;">Recusar</button>
            </div>
        </div>
    </div>

    <!-- Cookie Consent JavaScript -->
    <script>
    (function(){
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        // Check if user has already made a choice
        const consent = getCookie('innovasus_cookie_consent');
        if (!consent) {
            const banner = document.getElementById('cookie-consent');
            if (banner) {
                banner.style.display = 'block';
                
                // Accept button handler
                const acceptBtn = document.getElementById('cookie-accept-btn');
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', function() {
                        setCookie('innovasus_cookie_consent', 'accepted', 365);
                        banner.style.display = 'none';
                    });
                }
                
                // Decline button handler
                const declineBtn = document.getElementById('cookie-decline-btn');
                if (declineBtn) {
                    declineBtn.addEventListener('click', function() {
                        setCookie('innovasus_cookie_consent', 'declined', 365);
                        banner.style.display = 'none';
                        // Optional: Disable non-essential cookies here
                    });
                }
            }
        }
    })();
    </script>

</body>
</html>
